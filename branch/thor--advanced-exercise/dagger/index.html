<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dagger &mdash; Julia for High-Performance Scientific Computing</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Message passing" href="../MPI/" />
    <link rel="prev" title="Distributed computing" href="../distributed/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Julia for High-Performance Scientific Computing
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Prerequisites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../motivation/">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performant-code/">Writing performant Julia code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multithreading/">Multithreading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed/">Distributed computing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Dagger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#task-graphs">Task Graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Dagger</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../MPI/">Message passing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster/">Running on a cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GPU/">GPU programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interfacing/">Interfacing to C and Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conclusions/">Summary and outlook</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optional episodes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../exercises/">Advanced exercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Julia for High-Performance Scientific Computing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Dagger</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/enccs/Julia-for-HPC/blob/master/content/dagger.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dagger">
<h1>Dagger<a class="headerlink" href="#dagger" title="Permalink to this heading"></a></h1>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What is a task graph, and how it relates to parallel execution?</p></li>
<li><p>How to use Dagger.jl to define and execute tasks in a task graph?</p></li>
</ul>
</div>
<div class="admonition-instructor-note instructor-note admonition" id="instructor-note-0">
<p class="admonition-title">Instructor note</p>
<ul class="simple">
<li><p>30 min teaching</p></li>
<li><p>30 min exercises</p></li>
</ul>
</div>
<section id="task-graphs">
<h2>Task Graphs<a class="headerlink" href="#task-graphs" title="Permalink to this heading"></a></h2>
<p>We can use a <cite>Directed Acyclic Graph</cite> (DAG) to model dependencies between computational tasks.
In the graph, the vertices are tasks, and the directed edges are dependencies between tasks.
Dependencies arise when the output of one task is an input to another task.
Task graphs are commonly used to represent scientific workflows.</p>
<figure class="align-center" id="id2">
<img alt="../_images/dag.png" src="../_images/dag.png" />
<figcaption>
<p><span class="caption-text">An example of a directed acyclic graph with vertices <span class="math notranslate nohighlight">\(V=\{1,2,3,4\}\)</span> and directed edges <span class="math notranslate nohighlight">\(E=\{(1,2), (1,3), (2,4), (3, 4)\}.\)</span>
The graph has two paths <span class="math notranslate nohighlight">\((1,2,4)\)</span> and <span class="math notranslate nohighlight">\((1,3,4).\)</span>
We can see that the vertices <span class="math notranslate nohighlight">\(2\)</span> and <span class="math notranslate nohighlight">\(3\)</span> are independent because there is no path between them.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Formally, a <strong>task graph</strong> is a directed acyclic graph consisting of a set of vertices <span class="math notranslate nohighlight">\(V=\{1,2,...,n\}\)</span> called <strong>tasks</strong> and a set of directed edges <span class="math notranslate nohighlight">\(E\subseteq \{(i,j) \mid i\in V, j\in V, i&lt;j \}\)</span> called <strong>dependencies</strong>.
We say that a task <span class="math notranslate nohighlight">\(j\)</span> <cite>depends</cite> on task <span class="math notranslate nohighlight">\(i\)</span> if there is a path from <span class="math notranslate nohighlight">\(i\)</span> to <span class="math notranslate nohighlight">\(j.\)</span>
Otherwise, the tasks are <cite>independent</cite>.
<strong>We can compute independent tasks in parallel.</strong></p>
<p>We also focus on task graphs that are <strong>dynamically generated</strong> such that a task can create new tasks and dependencies based on the inputs it receives.
In these cases, the complete task graph is known after computing it.</p>
<p>Some frameworks, such as <cite>Dask</cite> for Python and <cite>Dagger.jl</cite> for Julia, can express task graphs and automatically execute independent tasks in parallel.
Furthermore, they may support features such as out-of-core execution to process data larger than the memory and checkpointing for saving intermediate results to disk.
We focus on defining task graphs and parallel execution.</p>
</section>
<section id="id1">
<h2>Dagger<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p><cite>Dagger.jl</cite> can dynamically execute tasks on a task graph to execute independent tasks in parallel with available threads and distributed workers.
We can install Dagger with the package manager:</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Pkg</span>
<span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Dagger&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s start Julia with two threads using the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>julia<span class="w"> </span>--threads<span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<p>Then, we can add distributed workers and import Dagger as follows:</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span>

<span class="c"># We add one worker with two threads before loading Dagger</span>
<span class="n">addprocs</span><span class="p">(</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">exeflags</span><span class="o">=</span><span class="s">&quot;--threads=2&quot;</span><span class="p">)</span>

<span class="c"># Let&#39;s load Dagger on all workers</span>
<span class="nd">@everywhere</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">Dagger</span>
</pre></div>
</div>
<p>Dagger automatically creates Dagger processors, which it uses to execute tasks.
We can query the available processors as follows:</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">()</span>

<span class="c"># Dagger CPU (OS) processes (Dagger.OSProc)</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">procs</span>

<span class="c"># Dagger Thread processes on each CPU process (Dagger.ThreadProc)</span>
<span class="n">Dagger</span><span class="o">.</span><span class="n">get_processors</span><span class="o">.</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">procs</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we want to define and execute a task graph using Dagger.</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Add task function to all workers</span>
<span class="nd">@everywhere</span><span class="w"> </span><span class="n">task</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Distributed</span><span class="o">.</span><span class="n">myid</span><span class="p">(),</span><span class="w"> </span><span class="n">Threads</span><span class="o">.</span><span class="n">threadid</span><span class="p">())</span>

<span class="c"># Let&#39;s define a simple task graph consisting of 10 independent tasks</span>
<span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">task</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">]</span>

<span class="c"># Fetch the results</span>
<span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch</span><span class="o">.</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="s">&quot;(Worker ID, Thread ID)&quot;</span><span class="p">)</span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;Main process&quot;</span><span class="p">)</span>
<span class="n">println</span><span class="p">(</span><span class="n">task</span><span class="p">())</span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;Dagger tasks&quot;</span><span class="p">)</span>
<span class="n">foreach</span><span class="p">(</span><span class="n">println</span><span class="p">,</span><span class="w"> </span><span class="n">sort</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
<p>We can see that Dagger used thread one on worker one for scheduling tasks and the other Dagger processors to execute the tasks.</p>
<p>We can also specify more complex, dynamic task graphs since Dagger uses a dynamic scheduler and allows nesting tasks.
Here is an example of a dynamic task graph:</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">task_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">b</span><span class="o">+</span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">a</span><span class="p">]</span>
<span class="k">end</span>

<span class="c"># Define and execute a task graph</span>
<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="o">:</span><span class="mi">8</span><span class="p">)</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="o">:</span><span class="mi">20</span><span class="p">)</span>
<span class="c"># The value of `a` determines how many nested tasks are spawned</span>
<span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">task_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="o">:</span><span class="mi">20</span><span class="p">)</span>
<span class="c"># We use fetch inside @spawn so it does not block</span>
<span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dagger</span><span class="o">.</span><span class="nd">@spawn</span><span class="w"> </span><span class="o">+</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>

<span class="c"># Fetch the final result</span>
<span class="n">fetch</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../distributed/" class="btn btn-neutral float-left" title="Distributed computing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../MPI/" class="btn btn-neutral float-right" title="Message passing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, EuroCC National Competence Center Sweden.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>